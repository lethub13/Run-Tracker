<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Run Tracker</title>
<style>
  :root { --bg:#f5f5f5; --card:#fff; --text:#111; --muted:#666; --brand:#0b67ff; --brand-d:#0852c7; }
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); margin: 20px; }
  h1 { text-align: center; margin-bottom: 16px; }
  .wrap { max-width: 980px; margin: 0 auto; display: grid; gap: 20px; }
  .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,.12); padding: 16px; }
  form label { display: grid; grid-template-columns: 160px 1fr; align-items: center; gap: 8px; margin: 10px 0; }
  input, select, button { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; }
  button { background: var(--brand); color: #fff; border: 1px solid transparent; cursor: pointer; }
  button:hover { background: var(--brand-d); }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .btn-secondary { background:#eee; color:#111; border-color:#ddd; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row>* { flex:1 1 220px; }
  .table-wrap { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border:1px solid #ddd; padding:8px; text-align:center; vertical-align: middle; }
  th { background:#eee; }
  .muted { color:var(--muted); }
  .toast { position:fixed; right:16px; bottom:16px; background:#222; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; transform:translateY(8px); transition:.25s; z-index:1000; }
  .toast.show { opacity:1; transform:translateY(0); }

  /* Collapsible Past Activities */
  details.card { padding: 0; }
  details.card > .content { padding: 0 16px 16px 16px; }
  .summary-row {
    list-style: none; display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding:14px 16px; cursor:pointer; font-weight:700; border-bottom:1px solid #eee; user-select:none;
  }
  .summary-row .right { display:flex; align-items:center; gap:8px; }
  .chev { transition: transform .2s ease; }
  details[open] .chev { transform: rotate(0deg); }
  details:not([open]) .chev { transform: rotate(-90deg); }
  .count { font-weight: 400; color: var(--muted); margin-left: 6px; }

  /* Avatars */
  .name-cell { display:flex; align-items:center; gap:8px; }
  .avatar { width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#fff; flex:0 0 28px; }

  /* Social inline counts */
  .social-inline { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; font-size:13px; }
  .rx { display:inline-flex; gap:4px; align-items:center; padding:2px 6px; border:1px solid #e5e5e5; border-radius:999px; background:#fafafa; }
  .rx .cnt { min-width:1.2em; text-align:right; }

  /* Kebab menu */
  .kebab { background:#fff; color:#111; border:1px solid #ddd; width:32px; height:32px; border-radius:6px; }
  .menu { position:absolute; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.15); padding:6px; display:none; z-index:800; }
  .menu.show { display:block; }
  .menu button { background:transparent; color:#111; border:none; padding:8px 10px; width:100%; text-align:left; border-radius:6px; }
  .menu button:hover { background:#f5f5f5; }

  /* Modals */
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:900; }
  .modal-backdrop.show { display:flex; }
  .modal { background:#fff; width:min(560px,92vw); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:16px; }
  .emoji-grid { display:flex; flex-wrap:wrap; gap:8px; }
  .emoji-grid button { font-size:22px; background:#fff; border:1px solid #eee; border-radius:8px; padding:6px 10px; }
  .emoji-grid button:hover { background:#f5f5f5; }
  .comments-list { display:flex; flex-direction:column; gap:8px; margin:10px 0; max-height:50vh; overflow:auto; }
  .comment-row { display:flex; gap:8px; align-items:flex-start; justify-content:space-between; border:1px solid #eee; padding:8px; border-radius:8px; }
  .comment-meta { font-size:12px; color:var(--muted); }
  .danger { background:#e53935 !important; color:#fff !important; border-color:#e53935 !important; }

  /* Badge chips on leaderboard */
  .badges { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
  .badge  { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #e5e5e5; border-radius:999px; background:#fafafa; font-size:12px; white-space:nowrap; }
  .badge i { font-style: normal; }
</style>
</head>
<body>
<h1>Run Tracker</h1>

<div class="wrap">
  <!-- Add Run -->
  <div class="card">
    <form id="runForm">
      <div class="row">
        <label>Date: <input type="date" id="date" required /></label>
        <label>Name: <input type="text" id="name" placeholder="Your name" required /></label>
      </div>
      <div class="row">
        <label>Distance (km): <input type="number" id="distance" step="0.01" min="0.01" placeholder="e.g. 5" required /></label>
        <label>Time (duration):
          <span class="display-chip">
            <code id="timeDisplay">--:--:--</code>
            <button id="openTimePicker" type="button" class="btn-secondary">Pick Time</button>
          </span>
          <input type="hidden" id="time" value="" />
        </label>
      </div>
      <div class="row">
        <button id="submitBtn" type="submit" disabled>Add Run</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="row">
      <label for="filterSelect">Filter by Name:
        <select id="filterSelect"><option value="">-- All Names --</option></select>
      </label>
      <button id="refreshBtn" type="button" class="btn-secondary" style="max-width:160px">Refresh</button>
    </div>
  </div>

  <!-- Past Activities -->
  <details id="secActivities" class="card" open>
    <summary class="summary-row">
      <span>Past Activities <span id="activitiesCount" class="count"></span></span>
      <span class="right"><span id="activitiesTotal" class="muted"></span><span class="chev" aria-hidden="true">▾</span></span>
    </summary>
    <div class="content">
      <div class="table-wrap">
        <table aria-live="polite">
          <thead>
            <tr>
              <th>Date</th><th>Name</th><th>Distance (km)</th><th>Time</th><th>Pace (min/km)</th><th>⋯</th>
            </tr>
          </thead>
          <tbody id="activitiesTable"></tbody>
        </table>
      </div>
    </div>
  </details>

  <!-- Leaderboard with badge chips -->
  <div class="card">
    <h2>Leaderboard</h2>
    <div class="table-wrap">
      <table aria-live="polite">
        <thead><tr><th>Name</th><th>Total Distance (km)</th><th>Total Time</th><th>Badges</th></tr></thead>
        <tbody id="leaderboardTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- React Picker Modal -->
<div id="reactModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <h3>React to this run</h3>
    <div class="emoji-grid" id="emojiGrid"></div>
    <div style="text-align:right;margin-top:10px">
      <button type="button" class="btn-secondary" id="reactClose">Close</button>
    </div>
  </div>
</div>

<!-- Comments Modal -->
<div id="commentsModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Comments</h3>
    <div id="commentsList" class="comments-list"></div>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <input type="text" id="cName" placeholder="Your name (optional)" style="flex:0 0 30%">
      <input type="text" id="cText" placeholder="Write a comment…" style="flex:1">
      <button id="cPost">Post</button>
    </div>
    <div style="text-align:right;margin-top:10px">
      <button type="button" class="btn-secondary" id="commentsClose">Close</button>
    </div>
  </div>
</div>

<!-- Time picker -->
<div id="timeModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Select Duration</h3>
    <div style="display:flex; gap:8px; align-items:center;">
      <select id="tpH"></select> :
      <select id="tpM"></select> :
      <select id="tpS"></select>
    </div>
    <div style="text-align:right;margin-top:10px">
      <button type="button" class="btn-secondary" id="tpCancel">Cancel</button>
      <button type="button" id="tpSet">Set</button>
    </div>
  </div>
</div>

<script>
/* ===== Config ===== */
const scriptUrl = "/api/proxy";

/* ===== DOM ===== */
const runForm = document.getElementById("runForm");
const activitiesTable = document.getElementById("activitiesTable");
const leaderboardTable = document.getElementById("leaderboardTable");
const filterSelect = document.getElementById("filterSelect");
const statusEl = document.getElementById("status");
const refreshBtn = document.getElementById("refreshBtn");
const toastEl = document.getElementById("toast");
const activitiesCountEl = document.getElementById("activitiesCount");
const activitiesTotalEl = document.getElementById("activitiesTotal");

/* Time widgets */
const timeHidden = document.getElementById("time");
const timeDisplay = document.getElementById("timeDisplay");
const openTimePicker = document.getElementById("openTimePicker");
const timeModal = document.getElementById("timeModal");
const tpH = document.getElementById("tpH"), tpM = document.getElementById("tpM"), tpS = document.getElementById("tpS");
const tpCancel = document.getElementById("tpCancel"), tpSet = document.getElementById("tpSet");
const submitBtn = document.getElementById("submitBtn");

/* React + Comments modals */
const reactModal = document.getElementById("reactModal");
const emojiGrid = document.getElementById("emojiGrid");
const reactClose = document.getElementById("reactClose");
const commentsModal = document.getElementById("commentsModal");
const commentsList = document.getElementById("commentsList");
const cName = document.getElementById("cName"), cText = document.getElementById("cText"), cPost = document.getElementById("cPost");
const commentsClose = document.getElementById("commentsClose");

/* ===== Utils ===== */
function toast(m){ toastEl.textContent=m; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"),2400); }
const pad2 = n => String(n).padStart(2,"0");
function normalizeTimeStr(t){
  if(!t) return "";
  const s=String(t).trim();
  if (s.includes("T")) return s.split("T")[1].slice(0,8);
  if (/^\d{1,2}:[0-5]\d$/.test(s)) return `00:${s}`;
  if (/^\d{1,2}:[0-5]\d:[0-5]\d$/.test(s)) { const [h,m,ss]=s.split(":"); return `${pad2(h)}:${m}:${ss}`; }
  return s;
}
function timeToSeconds(t){
  const s = normalizeTimeStr(t); if(!s) return 0;
  const [h,m,ss] = s.split(":").map(Number);
  if ([h,m,ss].some(Number.isNaN)) return 0;
  return h*3600 + m*60 + ss;
}
function secondsToHMS(sec){
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=Math.floor(sec%60);
  return [h,m,s].map(pad2).join(":");
}
function calcPace(distanceKm, timeStr){
  const secs = timeToSeconds(timeStr);
  if (!distanceKm || distanceKm <= 0 || secs <= 0) return "-";
  const pace = secs / distanceKm;
  const m = Math.floor(pace/60);
  const s = Math.round(pace % 60);
  return `${m}:${pad2(s)}`;
}
function formatDate(dateStr){ return dateStr && dateStr.includes("T") ? dateStr.split("T")[0] : (dateStr||""); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

/* Avatars */
const PALETTE = ["#E57373","#F06292","#BA68C8","#9575CD","#7986CB","#64B5F6","#4FC3F7","#4DD0E1","#4DB6AC","#81C784","#AED581","#DCE775","#FFF176","#FFD54F","#FFB74D","#A1887F","#90A4AE"];
function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
function colorForName(name){ if(!name) return "#888"; return PALETTE[hashCode(name)%PALETTE.length]; }
function initials(name){ const parts=String(name||"").trim().split(/\s+/).filter(Boolean); if (!parts.length) return "?"; if (parts.length===1) return parts[0].slice(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
function avatarHTML(name){ const bg=colorForName(name), text=initials(name); return `<span class="avatar" style="background:${bg}">${text}</span>`; }

/* ===== Badges (progress sash) on leaderboard ===== */
function getBadges(km) {
  const badges = [];
  if (km >= 5)    badges.push("🏁 5K");
  if (km >= 10)   badges.push("🥉 10K");
  if (km >= 21.1) badges.push("🥈 Half");
  if (km >= 42.2) badges.push("🎖️ Marathon");
  if (km >= 50)  badges.push("🏅 50 km");
  if (km >= 100) badges.push("🥇 100 km");
  if (km >= 150) badges.push("🏆 150 km");
  if (km >= 200) badges.push("🚀 200 km");
  if (km >= 250) badges.push("🗻 250 km");
  if (km >= 300) badges.push("👑 300+ km");
  return badges;
}

/* ===== Social (frontend) ===== */
const POSITIVE_EMOJIS = ["👍","🎉","👏","💪","🔥","🥳","🏅","❤️"];
let _filteredActivities = [];
let _visibleIds = [];
let _reactTargetRunId = null;
let _commentsTargetRunId = null;

function openReact(runId){
  _reactTargetRunId = runId;
  emojiGrid.innerHTML = POSITIVE_EMOJIS.map(e => `<button type="button" data-emoji="${e}">${e}</button>`).join("");
  emojiGrid.querySelectorAll('button').forEach(btn=>{
    btn.onclick = async () => {
      const res = await safePost({ action:'react', runId, emoji: btn.dataset.emoji, name: localStorage.getItem('rt.me') || '' });
      if (res.ok) { hydrateReactions([runId]); }
      closeReact();
    };
  });
  reactModal.classList.add("show"); reactModal.setAttribute("aria-hidden","false");
}
function closeReact(){ reactModal.classList.remove("show"); reactModal.setAttribute("aria-hidden","true"); }
reactClose.onclick = closeReact;
reactModal.addEventListener("click", e=>{ if (e.target===reactModal) closeReact(); });

function openComments(runId){
  _commentsTargetRunId = runId;
  cText.value = "";
  loadComments(runId);
  commentsModal.classList.add("show"); commentsModal.setAttribute("aria-hidden","false");
}
function closeComments(){ commentsModal.classList.remove("show"); commentsModal.setAttribute("aria-hidden","true"); }
commentsClose.onclick = closeComments;
commentsModal.addEventListener("click", e=>{ if (e.target===commentsModal) closeComments(); });

async function loadComments(runId){
  const q = encodeURIComponent(runId);
  const data = await safeGet(`${scriptUrl}?entity=comments&ids=${q}`);
  const rows = (data && data[runId]) || [];
  commentsList.innerHTML = rows.length ? rows.map(r => `
    <div class="comment-row" data-cid="${esc(r.id)}">
      <div style="flex:1">
        <div><b>${esc(r.name||'Anonymous')}</b></div>
        <div>${esc(r.comment)}</div>
        <div class="comment-meta">${esc(r.dt||'')}</div>
      </div>
      <div>
        <button class="danger" data-del="${esc(r.id)}">🗑️</button>
      </div>
    </div>
  `).join("") : '<div class="muted">No comments yet</div>';

  commentsList.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      const commentId = btn.dataset.del;
      const pin = prompt("Moderator PIN to delete:");
      if (!pin) return;
      const res = await safePost({ action:'deleteComment', commentId, pin });
      if (res.ok){ toast("Deleted"); loadComments(runId); }
    };
  });
}

cPost.onclick = async ()=>{
  const runId = _commentsTargetRunId;
  const name = cName.value.trim();
  const text = cText.value.trim();
  if (!runId || !text){ toast("Write something"); return; }
  const res = await safePost({ action:'comment', runId, name, comment: text });
  if (res.ok) { cText.value = ""; loadComments(runId); }
};

async function hydrateReactions(ids){
  if (!ids.length) return;
  const q = encodeURIComponent(ids.join(','));
  const data = await safeGet(`${scriptUrl}?entity=reactions&ids=${q}`);
  ids.forEach(id=>{
    const bar = document.querySelector(`.social-inline[data-runid="${CSS.escape(String(id))}"]`);
    if (!bar) return;
    const list = (data && data[id]) || [];
    const counts = {};
    list.forEach(r => counts[r.emoji]=(counts[r.emoji]||0)+1);
    const chips = POSITIVE_EMOJIS
      .filter(e => counts[e])
      .map(e => `<span class="rx"><span>${e}</span><span class="cnt">${counts[e]}</span></span>`);
    bar.innerHTML = chips.join("") || `<span class="muted">No reactions yet</span>`;
  });
}

/* Robust fetch helpers (warn on non-JSON / auth HTML) */
async function safeGet(url){
  try{
    const r = await fetch(url, { cache:'no-store' });
    const ct = r.headers.get('content-type') || '';
    if (!r.ok) { toast(`Error ${r.status} on GET`); return null; }
    if (!ct.includes('application/json')) {
      toast('Backend blocked (check Apps Script “Anyone with the link”)');
      return null;
    }
    return await r.json();
  }catch(e){ toast('Network error'); return null; }
}
async function safePost(body){
  try{
    const r = await fetch(scriptUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const ct = r.headers.get('content-type') || '';
    if (!r.ok) { toast(`Error ${r.status} on POST`); return { ok:false }; }
    if (!ct.includes('application/json')) {
      toast('Backend blocked (check Apps Script “Anyone with the link”)');
      return { ok:false };
    }
    const j = await r.json();
    if (j && j.ok) return j;
    toast(j && j.error ? j.error : 'Request failed');
    return j || { ok:false };
  }catch(e){ toast('Network error'); return { ok:false }; }
}

/* ===== Time picker ===== */
function buildTimeOptions(){
  for (let h=0; h<=23; h++){ tpH.append(new Option(pad2(h), pad2(h))); }
  for (let m=0; m<=59; m++){ tpM.append(new Option(pad2(m), pad2(m))); tpS.append(new Option(pad2(m), pad2(m))); }
}
buildTimeOptions();
openTimePicker.addEventListener("click", ()=>{
  const base=timeHidden.value||"00:00:00"; const [h,m,s]=normalizeTimeStr(base).split(":");
  tpH.value=h; tpM.value=m; tpS.value=s;
  timeModal.classList.add("show"); timeModal.setAttribute("aria-hidden","false");
});
tpCancel.onclick = ()=>{ timeModal.classList.remove("show"); timeModal.setAttribute("aria-hidden","true"); };
tpSet.onclick = ()=>{
  const val = `${tpH.value}:${tpM.value}:${tpS.value}`;
  timeHidden.value = val; timeDisplay.textContent = val; submitBtn.disabled = false;
  timeModal.classList.remove("show"); timeModal.setAttribute("aria-hidden","true");
};

/* ===== Data ===== */
async function fetchActivities(){
  statusEl.textContent="Loading…";
  try{
    const activities = await safeGet(scriptUrl) || [];
    activities.sort((a,b)=> new Date(b.date) - new Date(a.date));

    // Filter dropdown
    const prev = filterSelect.value;
    filterSelect.innerHTML = '<option value="">-- All Names --</option>';
    [...new Set(activities.map(r => r.name).filter(Boolean))].sort().forEach(name=>{
      const opt=document.createElement("option");
      opt.value=name; opt.textContent=name; if (name===prev) opt.selected=true; filterSelect.appendChild(opt);
    });

    const filter = filterSelect.value.trim().toLowerCase();
    const filtered = filter ? activities.filter(r => (r.name||"").toLowerCase()===filter) : activities;
    _filteredActivities = filtered;

    activitiesCountEl.textContent = filtered.length ? `(${filtered.length})` : "";
    const totalKm = filtered.reduce((sum,r)=> sum + (parseFloat(String(r.distance).replace(",", "."))||0), 0);
    activitiesTotalEl.textContent = filtered.length ? `${totalKm.toFixed(2)} km` : "";

    activitiesTable.innerHTML = "";
    const visibleIds = [];
    if (!filtered.length){
      activitiesTable.innerHTML = "<tr><td colspan='6' class='muted'>No runs yet</td></tr>";
    } else {
      filtered.forEach(r=>{
        const id = r.id;
        const date = formatDate(r.date);
        const name = r.name || "";
        const dist = parseFloat(String(r.distance).replace(",", ".")) || 0;
        const time = normalizeTimeStr(r.time || "");
        const pace = r.pace || calcPace(dist, time);

        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${date}</td>
          <td><span class="name-cell">${avatarHTML(name)}<span>${esc(name)}</span></span></td>
          <td>${dist?dist.toFixed(2):""}</td>
          <td>${time||""}</td>
          <td>${pace}</td>
          <td style="position:relative">
            <div class="social-inline" data-runid="${id}" style="margin-bottom:6px;"></div>
            <button class="kebab" type="button" aria-label="More" data-menu="${id}">⋯</button>
            <div class="menu" id="menu-${id}">
              <button data-react="${id}">😀 React</button>
              <button data-comment="${id}">✍️ Comment</button>
              <button data-view="${id}">💬 View Comments</button>
            </div>
          </td>
        `;
        activitiesTable.appendChild(tr);
        visibleIds.push(id);
      });
    }
    _visibleIds = visibleIds;

    // kebab menus
    document.querySelectorAll('[data-menu]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.dataset.menu;
        const menu = document.getElementById(`menu-${id}`);
        document.querySelectorAll('.menu.show').forEach(m=>{ if(m!==menu) m.classList.remove('show'); });
        menu.classList.toggle("show");
      };
    });
    document.addEventListener('click', (e)=>{
      if (!e.target.closest('.menu') && !e.target.closest('[data-menu]')){
        document.querySelectorAll('.menu.show').forEach(m=>m.classList.remove('show'));
      }
    });

    // actions
    document.querySelectorAll('[data-react]').forEach(b=>{
      b.onclick = ()=>{ openReact(b.dataset.react); b.closest('.menu').classList.remove('show'); };
    });
    document.querySelectorAll('[data-comment]').forEach(b=>{
      b.onclick = ()=>{ openComments(b.dataset.comment); cText.focus(); b.closest('.menu').classList.remove('show'); };
    });
    document.querySelectorAll('[data-view]').forEach(b=>{
      b.onclick = ()=>{ openComments(b.dataset.view); b.closest('.menu').classList.remove('show'); };
    });

    hydrateReactions(visibleIds);

    // Leaderboard with badge chips
    const summary = {};
    activities.forEach(r=>{
      const name = r.name || "";
      const dist = parseFloat(String(r.distance).replace(",", ".")) || 0;
      const secs = timeToSeconds(r.time);
      if (!summary[name]) summary[name] = { dist:0, secs:0 };
      summary[name].dist += dist;
      summary[name].secs += secs;
    });
    const sorted=Object.entries(summary).filter(([n])=>n).sort((a,b)=>b[1].dist-a[1].dist);
    leaderboardTable.innerHTML = "";
    if (!sorted.length){
      leaderboardTable.innerHTML = "<tr><td colspan='4' class='muted'>No runners yet</td></tr>";
    } else {
      sorted.forEach(([name,vals])=>{
        const badgesArr = getBadges(vals.dist);
        const badgesHtml = badgesArr.length
          ? `<div class="badges">${badgesArr.map(b => `<span class="badge"><i>${b.split(' ')[0]}</i><span>${b.replace(/^[^ ]+ /,'')}</span></span>`).join("")}</div>`
          : "";
        const row=document.createElement("tr");
        row.innerHTML = `
          <td><span class="name-cell">${avatarHTML(name)}<span>${esc(name)}</span></span></td>
          <td>${vals.dist.toFixed(2)}</td>
          <td>${secondsToHMS(vals.secs)}</td>
          <td>${badgesHtml}</td>`;
        leaderboardTable.appendChild(row);
      });
    }

  } catch (err){
    console.error(err); toast("Failed to load activities");
  } finally {
    statusEl.textContent="";
  }
}

/* Submit run */
runForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const t = normalizeTimeStr(timeHidden.value);
  if (!t){ toast("Pick a time"); return; }
  const payload = {
    date: document.getElementById("date").value,
    name: document.getElementById("name").value.trim(),
    distance: document.getElementById("distance").value,
    time: t
  };
  const res = await safePost(payload);
  if (res.ok){
    runForm.reset(); timeHidden.value=""; timeDisplay.textContent="--:--:--"; submitBtn.disabled=true;
    toast("Run added");
    await fetchActivities();
  }
});

/* Interactions */
filterSelect.addEventListener("change", fetchActivities);
refreshBtn.addEventListener("click", fetchActivities);
timeHidden.addEventListener("change", ()=> submitBtn.disabled = !timeHidden.value);

/* Initial */
fetchActivities();
</script>
</body>
</html>
