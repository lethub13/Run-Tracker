<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Run Tracker</title>
<style>
  :root { --bg:#f5f5f5; --card:#fff; --text:#111; --muted:#666; --brand:#007bff; --brand-d:#0056b3; --overlay:rgba(0,0,0,.5);}
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); margin: 20px; }
  h1 { text-align: center; margin-bottom: 16px; }
  .wrap { max-width: 900px; margin: 0 auto; display: grid; gap: 20px; }
  .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,.12); padding: 16px; }
  form label { display: grid; grid-template-columns: 160px 1fr; align-items: center; gap: 8px; margin: 10px 0; }
  input, select, button { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; }
  input:focus, select:focus { outline: none; border-color: var(--brand); }
  button { border: none; background: var(--brand); color: #fff; cursor: pointer; }
  button:hover { background: var(--brand-d); }
  .row { display: flex; gap: 10px; flex-wrap: wrap; }
  .row > * { flex: 1 1 220px; }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background: #eee; }
  .muted { color: var(--muted); }
  .toast { position: fixed; right: 16px; bottom: 16px; background: #222; color: #fff; padding: 10px 14px; border-radius: 8px; opacity: 0; transform: translateY(8px); transition: .25s; }
  .toast.show { opacity: 1; transform: translateY(0); }

  /* ===== Modal time picker ===== */
  .modal-overlay { position: fixed; inset: 0; background: var(--overlay); display: none; align-items: flex-end; justify-content: center; }
  .modal { width: 100%; max-width: 520px; background: var(--card); border-radius: 16px 16px 0 0; box-shadow: 0 -4px 16px rgba(0,0,0,.25); padding: 16px; }
  .modal header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .modal .wheels { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding: 8px 0; }
  .modal .wheel { position: relative; height: 180px; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; scroll-snap-type: y mandatory; background: #fafafa; }
  .wheel::-webkit-scrollbar { width: 0; height: 0; }
  .wheel .item { height: 40px; display: grid; place-items: center; font-size: 18px; scroll-snap-align: center; }
  .modal .mask { position: absolute; left: 0; right: 0; top: 70px; height: 40px; border-top: 2px solid var(--brand); border-bottom: 2px solid var(--brand); pointer-events: none; }
  .modal footer { display: flex; gap: 10px; justify-content: flex-end; }
  .btn-ghost { background: transparent; color: var(--brand); border: 1px solid var(--brand); }
  .time-input-wrap { display:flex; gap:8px; align-items:center; }
  .time-display { flex:1; }
</style>
</head>
<body>
<h1>Run Tracker</h1>

<div class="wrap">
  <!-- Add Run -->
  <div class="card">
    <form id="runForm" aria-label="Add new run">
      <div class="row">
        <label>Date:
          <input type="date" id="date" required />
        </label>
        <label>Name:
          <input type="text" id="name" placeholder="Your name" required />
        </label>
      </div>
      <div class="row">
        <label>Distance (km):
          <input type="number" id="distance" step="0.01" min="0.01" placeholder="e.g. 5" required />
        </label>
        <label>Time (duration):
          <div class="time-input-wrap">
            <input class="time-display" id="time" type="text" placeholder="HH:MM:SS" readonly required />
            <button id="openTimePicker" type="button">Select</button>
          </div>
        </label>
      </div>
      <div class="row">
        <button type="submit">Add Run</button>
        <span class="muted" id="status" aria-live="polite"></span>
      </div>
    </form>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="row">
      <label for="filterSelect">Filter by Name:
        <select id="filterSelect">
          <option value="">-- All Names --</option>
        </select>
      </label>
      <button id="refreshBtn" type="button" style="max-width:160px">Refresh</button>
    </div>
  </div>

  <!-- Past Activities -->
  <div class="card">
    <h2>Past Activities</h2>
    <div class="table-wrap">
      <table aria-live="polite">
        <thead>
          <tr>
            <th>Date</th><th>Name</th><th>Distance (km)</th><th>Time</th><th>Pace (min/km)</th>
          </tr>
        </thead>
        <tbody id="activitiesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="card">
    <h2>Leaderboard</h2>
    <div class="table-wrap">
      <table aria-live="polite">
        <thead>
          <tr><th>Name</th><th>Total Distance (km)</th><th>Total Time</th><th>Badge</th></tr>
        </thead>
        <tbody id="leaderboardTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Support -->
  <div class="card" style="text-align:center">
    <h3>Support this App</h3>
    <form action="https://www.paypal.com/donate" method="post" target="_top">
      <input type="hidden" name="hosted_button_id" value="WYBRQ9EGCMK4Y" />
      <input type="image"
             src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif"
             border="0" name="submit" alt="Donate with PayPal button"
             style="max-width:100%;height:auto;" />
    </form>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ===== Modal time picker (popup) ===== -->
<div id="timeModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="timeTitle">
    <header>
      <strong id="timeTitle">Select Duration</strong>
      <button id="closeTimePicker" type="button" class="btn-ghost">Close</button>
    </header>
    <div class="wheels">
      <div class="wheel" id="wheelH" aria-label="Hours"><div class="mask"></div></div>
      <div class="wheel" id="wheelM" aria-label="Minutes"><div class="mask"></div></div>
      <div class="wheel" id="wheelS" aria-label="Seconds"><div class="mask"></div></div>
    </div>
    <footer>
      <button id="setTime" type="button">Set Time</button>
    </footer>
  </div>
</div>

<script>
/* ===== Config (Vercel) ===== */
const scriptUrl = "/api/proxy";

/* ===== DOM ===== */
const runForm = document.getElementById("runForm");
const activitiesTable = document.getElementById("activitiesTable");
const leaderboardTable = document.getElementById("leaderboardTable");
const filterSelect = document.getElementById("filterSelect");
const statusEl = document.getElementById("status");
const refreshBtn = document.getElementById("refreshBtn");
const timeInput = document.getElementById("time");
const openTimePickerBtn = document.getElementById("openTimePicker");
const closeTimePickerBtn = document.getElementById("closeTimePicker");
const timeModal = document.getElementById("timeModal");
const setTimeBtn = document.getElementById("setTime");
const wheelH = document.getElementById("wheelH");
const wheelM = document.getElementById("wheelM");
const wheelS = document.getElementById("wheelS");

/* ===== Toast ===== */
function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2200);
}

/* ===== Duration helpers ===== */
function pad2(n){ return String(n).padStart(2,"0"); }
function normalizeTimeStr(t) {
  if (!t) return "";
  const s = String(t).trim();
  if (/^\d{1,2}:[0-5]\d$/.test(s)) return `00:${s}`;
  if (/^\d{1,2}:[0-5]\d:[0-5]\d$/.test(s)) {
    const [a,b,c] = s.split(":");
    return `${pad2(a)}:${b}:${c}`;
  }
  if (s.includes("T")) return s.split("T")[1].slice(0,8);
  return s;
}
function timeToSeconds(t){
  const s = normalizeTimeStr(t);
  if (!s) return 0;
  const [h=0,m=0,s2=0] = s.split(":").map(Number);
  if ([h,m,s2].some(Number.isNaN)) return 0;
  return h*3600 + m*60 + s2;
}
function secondsToHMS(sec){
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = Math.floor(sec%60);
  return [h,m,s].map(pad2).join(":");
}
function calcPace(distanceKm, timeStr){
  const secs = timeToSeconds(timeStr);
  if (!distanceKm || distanceKm <= 0 || secs <= 0) return "-";
  const pace = secs / distanceKm; // seconds/km
  const m = Math.floor(pace/60);
  const s = Math.round(pace % 60);
  return `${m}:${pad2(s)}`;
}
function getBadge(km) {
  if (km >= 42.2) return "ðŸ… Marathon";
  if (km >= 21.1) return "ðŸ¥ˆ Half";
  if (km >= 10) return "ðŸ¥‰ 10K";
  return "";
}
function formatDate(dateStr) {
  if (!dateStr) return "";
  return dateStr.includes("T") ? dateStr.split("T")[0] : dateStr;
}

/* ===== Time Modal (rolling selector) ===== */
function buildWheel(el, max){
  // add top/bottom spacers so center aligns nicely
  const spacer = document.createElement("div");
  spacer.className = "item";
  spacer.style.visibility = "hidden";
  spacer.style.height = "70px";
  el.appendChild(spacer.cloneNode());

  for (let i=0;i<=max;i++){
    const d = document.createElement("div");
    d.className = "item";
    d.textContent = pad2(i);
    el.appendChild(d);
  }

  el.appendChild(spacer.cloneNode());
}

function openTimeModal(initial="00:00:00"){
  // lazy build once
  if (!wheelH.dataset.built){
    buildWheel(wheelH, 23);
    buildWheel(wheelM, 59);
    buildWheel(wheelS, 59);
    wheelH.dataset.built = wheelM.dataset.built = wheelS.dataset.built = "1";
  }

  const parts = normalizeTimeStr(initial || "00:00:00").split(":").map(n=>parseInt(n||"0",10));
  const [h=0,m=0,s=0] = parts;

  // scroll so selected numbers are centered under the mask
  const itemH = 40; // must match CSS .item height
  const offset = 70; // mask top offset in CSS
  wheelH.scrollTop = (h * itemH);
  wheelM.scrollTop = (m * itemH);
  wheelS.scrollTop = (s * itemH);

  timeModal.style.display = "flex";
  timeModal.setAttribute("aria-hidden","false");
}

function closeTimeModal(){
  timeModal.style.display = "none";
  timeModal.setAttribute("aria-hidden","true");
}

function getWheelValue(el, max){
  // round to nearest item
  const itemH = 40;
  let idx = Math.round(el.scrollTop / itemH);
  if (idx < 0) idx = 0;
  if (idx > max) idx = max;
  return idx;
}

openTimePickerBtn.addEventListener("click", () => openTimeModal(timeInput.value));
closeTimePickerBtn.addEventListener("click", closeTimeModal);
timeModal.addEventListener("click", (e)=>{ if (e.target === timeModal) closeTimeModal(); });

setTimeBtn.addEventListener("click", () => {
  const h = getWheelValue(wheelH, 23);
  const m = getWheelValue(wheelM, 59);
  const s = getWheelValue(wheelS, 59);
  timeInput.value = `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  closeTimeModal();
});

/* ===== Data Fetch ===== */
async function fetchActivities(){
  statusEl.textContent = "Loadingâ€¦";
  try {
    const res = await fetch(scriptUrl);
    const activities = await res.json();

    // Build filter dropdown (preserve selection)
    const prev = filterSelect.value;
    filterSelect.innerHTML = '<option value="">-- All Names --</option>';
    [...new Set(activities.map(r => r.name).filter(Boolean))].sort()
      .forEach(name => {
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        if (name === prev) opt.selected = true;
        filterSelect.appendChild(opt);
      });

    const filter = filterSelect.value.trim().toLowerCase();
    const filtered = filter ? activities.filter(r => (r.name || "").toLowerCase() === filter) : activities;

    // Activities table
    activitiesTable.innerHTML = "";
    if (filtered.length === 0) {
      activitiesTable.innerHTML = "<tr><td colspan='5' class='muted'>No runs yet</td></tr>";
    } else {
      filtered.forEach(r => {
        const tr = document.createElement("tr");
        const date = formatDate(r.date);
        const dist = parseFloat(String(r.distance).replace(",", ".")) || 0;
        const time = normalizeTimeStr(r.time || "");
        const pace = r.pace || calcPace(dist, time);

        tr.innerHTML = `
          <td>${date}</td>
          <td>${r.name || ""}</td>
          <td>${dist ? dist.toFixed(2) : ""}</td>
          <td>${time || ""}</td>
          <td>${pace}</td>
        `;
        activitiesTable.appendChild(tr);
      });
    }

    // Leaderboard
    const summary = {};
    activities.forEach(r => {
      const name = r.name || "";
      const dist = parseFloat(String(r.distance).replace(",", ".")) || 0;
      const secs = timeToSeconds(r.time);
      if (!summary[name]) summary[name] = { dist: 0, secs: 0 };
      summary[name].dist += dist;
      summary[name].secs += secs;
    });

    const sorted = Object.entries(summary)
      .filter(([name]) => name)
      .sort((a,b) => b[1].dist - a[1].dist);

    leaderboardTable.innerHTML = "";
    if (sorted.length === 0) {
      leaderboardTable.innerHTML = "<tr><td colspan='4' class='muted'>No runners yet</td></tr>";
    } else {
      sorted.forEach(([name, vals]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>${vals.dist.toFixed(2)}</td>
          <td>${secondsToHMS(vals.secs)}</td>
          <td>${getBadge(vals.dist)}</td>
        `;
        leaderboardTable.appendChild(tr);
      });
    }

  } catch (err) {
    console.error(err);
    toast("Failed to load activities");
  } finally {
    statusEl.textContent = "";
  }
}

/* ===== Submit Handler ===== */
runForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const data = {
    date: document.getElementById("date").value,
    name: document.getElementById("name").value.trim(),
    distance: document.getElementById("distance").value,
    time: normalizeTimeStr(timeInput.value) // already HH:MM:SS from picker
  };

  if (!data.date || !data.name || !data.distance || !data.time) {
    toast("Fill Date, Name, Distance & Time");
    return;
  }

  try {
    const resp = await fetch(scriptUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    let json = {};
    try { json = await resp.json(); } catch {}

    if (!resp.ok || json.ok === false) {
      const msg = (json && (json.error || json.details)) || `Save failed (HTTP ${resp.status})`;
      console.error("Save error:", json);
      toast("Could not save: " + msg);
      return;
    }

    runForm.reset();
    toast("Run added");
    await fetchActivities();
  } catch (err) {
    console.error(err);
    toast("Network error while saving");
  }
});

/* ===== Interactions ===== */
filterSelect.addEventListener("change", fetchActivities);
refreshBtn.addEventListener("click", fetchActivities);

/* ===== Initial Load ===== */
fetchActivities();
</script>
</body>
</html>
