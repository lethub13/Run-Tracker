<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <style>
    body { background: #f9fafb; }
    .card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .badge { background: #e5e7eb; border-radius: 9999px; padding: 0.25rem 0.75rem; font-size: 0.8rem; margin: 0.25rem; display: inline-block; }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto space-y-6">

    <!-- Header -->
    <div class="card text-center">
      <h1 class="text-2xl font-bold">üèÉ Run Tracker</h1>
      <p class="text-gray-600">Track runs, earn badges, and climb the leaderboard!</p>
    </div>

    <!-- Run Form -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-3">Add a Run</h2>
      <form id="runForm" class="grid gap-3">
        <input type="text" id="name" placeholder="Your Name" class="border p-2 rounded" required />
        <input type="number" id="distance" placeholder="Distance (km)" class="border p-2 rounded" required />
        <input type="time" step="1" id="time" class="border p-2 rounded" required />
        <button class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">Submit Run</button>
      </form>
    </div>

    <!-- Filter -->
    <div class="card">
      <label class="font-semibold">Filter by Name:</label>
      <select id="filterSelect" class="border p-2 rounded mt-1 w-full"></select>
    </div>

    <!-- Leaderboard -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-3">üèÜ Leaderboard</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th class="p-2 border">Name</th>
            <th class="p-2 border">Total Distance (km)</th>
            <th class="p-2 border">Runs</th>
            <th class="p-2 border">Best Pace</th>
            <th class="p-2 border">Points</th>
            <th class="p-2 border">Badges</th>
          </tr>
        </thead>
        <tbody id="leaderboard"></tbody>
      </table>
    </div>

    <!-- Donate -->
    <div class="card text-center">
      <h2 class="text-xl font-semibold mb-2">Support this Project ‚ù§Ô∏è</h2>
      <form action="https://www.paypal.com/donate" method="post" target="_top">
        <input type="hidden" name="hosted_button_id" value="WYBRQ9EGCMK4Y" />
        <input type="image" 
          src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" 
          border="0" name="submit" 
          title="PayPal - The safer, easier way to pay online!" 
          alt="Donate with PayPal button" />
        <img alt="" border="0" 
          src="https://www.paypal.com/en_ZA/i/scr/pixel.gif" 
          width="1" height="1" />
      </form>
    </div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwEVecynbG6wXvjp7IRw7mE9iaDyin-N8vA2ylv0IXZi8syGcKNF8z_MWRoXVhuleUxEg/exec";
    const runForm = document.getElementById("runForm");
    const leaderboardBody = document.getElementById("leaderboard");
    const filterSelect = document.getElementById("filterSelect");
    let activities = [];

    // Convert hh:mm:ss -> seconds
    function parseTimeToSeconds(timeStr) {
      const parts = timeStr.split(":").map(Number);
      let sec = 0;
      if (parts.length === 3) sec = parts[0]*3600 + parts[1]*60 + parts[2];
      else if (parts.length === 2) sec = parts[0]*60 + parts[1];
      return sec;
    }

    // Format pace mm:ss per km
    function formatPace(secondsPerKm) {
      const mins = Math.floor(secondsPerKm / 60);
      const secs = Math.round(secondsPerKm % 60);
      return `${mins}:${secs.toString().padStart(2,"0")} /km`;
    }

    // Calculate badges
    function getBadges(totalDistance, runs, longest) {
      let badges = [];
      if (runs >= 1) badges.push("First Run!!");
      for (let km=5; km<=50; km+=5) {
        if (totalDistance >= km) badges.push(`${km}km Total`);
      }
      if (totalDistance >= 100) badges.push("100km Club");
      if (runs >= 10) badges.push("10 Runs Completed");
      if (longest >= 10) badges.push("Longest Single Run: 10km+");
      return badges;
    }

    // Fetch activities
    async function fetchActivities() {
      const res = await fetch(scriptUrl);
      const data = await res.json();
      activities = data;

      // Remember current filter
      const currentFilter = filterSelect.value.trim().toLowerCase();

      // Clear dropdown
      filterSelect.innerHTML = '';
      const allOption = document.createElement('option');
      allOption.value = '';
      allOption.textContent = '--All Names--';
      filterSelect.appendChild(allOption);

      // Unique names
      const namesSet = new Set(activities.map(r => r.name));
      namesSet.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name.toLowerCase() === currentFilter) opt.selected = true;
        filterSelect.appendChild(opt);
      });

      renderLeaderboard();
    }

    // Render leaderboard
    function renderLeaderboard() {
      const filterName = filterSelect.value.trim().toLowerCase();
      const filtered = filterName 
        ? activities.filter(r => r.name.toLowerCase() === filterName)
        : activities;

      // Group by name
      const summary = {};
      filtered.forEach(r => {
        const dist = parseFloat(r.distance);
        const secs = parseTimeToSeconds(r.time);
        if (!summary[r.name]) {
          summary[r.name] = { name: r.name, total: 0, runs: 0, bestPace: Infinity, longest: 0 };
        }
        summary[r.name].total += dist;
        summary[r.name].runs += 1;
        summary[r.name].longest = Math.max(summary[r.name].longest, dist);
        const pace = secs / dist;
        if (pace < summary[r.name].bestPace) summary[r.name].bestPace = pace;
      });

      // Sort by total distance
      const leaderboard = Object.values(summary).sort((a,b) => b.total - a.total);

      leaderboardBody.innerHTML = leaderboard.map(row => {
        const points = Math.floor(row.total / 5);
        const badges = getBadges(row.total, row.runs, row.longest);
        return `<tr>
          <td class="border p-2">${row.name}</td>
          <td class="border p-2">${row.total.toFixed(1)}</td>
          <td class="border p-2">${row.runs}</td>
          <td class="border p-2">${formatPace(row.bestPace)}</td>
          <td class="border p-2">${points}</td>
          <td class="border p-2">${badges.map(b=>`<span class="badge">${b}</span>`).join(" ")}</td>
        </tr>`;
      }).join("");
    }

    // Submit run
    runForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const distance = document.getElementById("distance").value;
      const time = document.getElementById("time").value;

      await fetch(scriptUrl, {
        method: "POST",
        body: new URLSearchParams({ name, distance, time })
      });

      runForm.reset();
      fetchActivities();
    });

    filterSelect.addEventListener("change", renderLeaderboard);

    fetchActivities();
  </script>
</body>
</html>
