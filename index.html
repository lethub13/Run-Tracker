<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Run Tracker</title>
<style>
body { font-family: Arial, sans-serif; margin:10px; background:#f4f4f4;}
form, .badges, .activity-table, .leaderboard { background:#fff; padding:15px; margin:10px auto; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
label { display:block; margin-top:10px;}
input, select { width:100%; padding:8px; margin-top:5px; box-sizing:border-box; }
button { margin-top:15px; padding:10px; width:100%; background:#007BFF; color:#fff; border:none; border-radius:5px; cursor:pointer; font-size:16px;}
button:hover {background:#0056b3;}
table { width:100%; border-collapse: collapse; margin-top:10px;}
th, td { border:1px solid #ddd; padding:6px; text-align:center;}
th { background:#007BFF; color:white;}
tbody tr:nth-child(even){background:#f2f2f2;}
tbody tr:hover {background:#d1e7ff;}
.pb-distance { background:#c6f5c6; }
.pb-pace { background:#c6d6f5; }
.badges span { display:inline-block; background:#ffdd57; color:#333; padding:5px 10px; margin:5px; border-radius:5px; font-weight:bold;}
.activity-table, .leaderboard { overflow-x:auto; }
@media(max-width:700px){
  table, th, td { font-size:12px; }
  button,input,select { font-size:14px; }
  h2,h3 { font-size:18px;}
}
</style>
</head>
<body>

<h2 style="text-align:center;">Run Tracker</h2>

<form id="activityForm">
<label>Select Name to Filter:</label>
<select id="filterName">
  <option value="">--Select Name--</option>
</select>

<label>Date:</label>
<input type="date" id="date" required>

<label>Name:</label>
<input type="text" id="name" placeholder="Your Name" required>

<label>Distance (km):</label>
<input type="number" id="distance" step="0.01" required>

<label>Time (HH:MM:SS):</label>
<input type="time" id="time" step="1" required>

<button type="submit">Add Activity</button>
</form>

<div class="badges">
<h3>Badges Earned</h3>
<div id="badgesContainer"></div>
</div>

<div class="activity-table">
<h3>Past Activities</h3>
<table id="activitiesTable">
<thead>
<tr><th>Date</th><th>Name</th><th>Distance (km)</th><th>Time</th><th>Pace (min/km)</th></tr>
</thead>
<tbody></tbody>
</table>
<p id="totals"></p>
</div>

<div class="leaderboard">
<h3>Leaderboard (Total Distance)</h3>
<table id="leaderboardTable">
<thead><tr><th>Name</th><th>Total Distance (km)</th><th>Points</th></tr></thead>
<tbody></tbody>
</table>
</div>

<script>
const form = document.getElementById('activityForm');
const tableBody = document.querySelector('#activitiesTable tbody');
const totals = document.getElementById('totals');
const filterSelect = document.getElementById('filterName');
const badgesContainer = document.getElementById('badgesContainer');
const leaderboardBody = document.querySelector('#leaderboardTable tbody');

const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwEVecynbG6wXvjp7IRw7mE9iaDyin-N8vA2ylv0IXZi8syGcKNF8z_MWRoXVhuleUxEg/exec';

function timeToMinutes(timeStr){
    const parts = timeStr.split(':');
    return parseInt(parts[0]||0)*60 + parseInt(parts[1]||0) + (parseInt(parts[2]||0)/60);
}
function formatTime(mins){
    const h = Math.floor(mins/60);
    const m = Math.floor(mins % 60);
    const s = Math.round((mins - Math.floor(mins))*60);
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
function formatPace(minutesDecimal){
    const mins = Math.floor(minutesDecimal);
    const secs = Math.round((minutesDecimal - mins) * 60);
    return `${mins}:${secs.toString().padStart(2,'0')}`;
}

form.addEventListener('submit', async function(e){
    e.preventDefault();
    const activity = {
        date: document.getElementById('date').value,
        name: document.getElementById('name').value, // always use input field
        distance: parseFloat(document.getElementById('distance').value),
        time: timeToMinutes(document.getElementById('time').value)
    };
    try{
        const response = await fetch(WEB_APP_URL,{method:'POST', body:JSON.stringify(activity)});
        const result = await response.json();
        if(result.status==='success'){ form.reset(); fetchActivities(); }
        else alert('Error saving activity');
    } catch(err){ 
        console.error(err); 
        alert('Failed to connect to Google Sheets. Offline mode will use cached data.');
    }
});

async function fetchActivities(){
    let activities = [];
    try {
        const response = await fetch(WEB_APP_URL);
        activities = await response.json();
        localStorage.setItem('cachedActivities', JSON.stringify(activities));
    } catch(err) {
        console.warn('Offline mode: loading cached data');
        activities = JSON.parse(localStorage.getItem('cachedActivities')) || [];
    }

    activities = activities.map(r=>({
        date:r.date||'',
        name:r.name||'',
        distance:parseFloat(r.distance)||0,
        time:parseFloat(r.time)||0
    }));

    // Populate filter dropdown
    const namesSet = new Set(activities.map(r => r.name));
    filterSelect.innerHTML = '<option value="">--Select Name--</option>';
    namesSet.forEach(name => {
        filterSelect.innerHTML += `<option value="${name}">${name}</option>`;
    });

    const filterName = filterSelect.value;
    const filtered = filterName ? activities.filter(r=>r.name===filterName) : [];

    let totalDistance=0, totalTime=0, maxDistance=0, minPace=Infinity, totalPoints=0;
    tableBody.innerHTML='';
    filtered.forEach(r=>{
        const paceDecimal = r.distance>0 ? r.time/r.distance : 0;
        const paceStr = formatPace(paceDecimal);
        totalDistance+=r.distance;
        totalTime+=r.time;
        totalPoints += Math.floor(r.distance / 5);
        if(r.distance>maxDistance) maxDistance=r.distance;
        if(r.distance>0 && paceDecimal<minPace) minPace=paceDecimal;

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date}</td><td>${r.name}</td><td>${r.distance}</td><td>${formatTime(r.time)}</td><td>${paceStr}</td>`;
        if(r.distance===maxDistance) tr.classList.add('pb-distance');
        if(r.distance>0 && paceDecimal===minPace) tr.classList.add('pb-pace');
        tableBody.appendChild(tr);
    });

    totals.textContent = `Total Distance: ${totalDistance.toFixed(2)} km | Total Time: ${formatTime(totalTime)} | Points: ${totalPoints}`;

    // Badges
    badgesContainer.innerHTML='';
    if(filtered.length>0) badgesContainer.innerHTML+='<span>First Run!!</span>';
    if(filtered.length>=10) badgesContainer.innerHTML+='<span>10 Runs Completed</span>';
    badgesContainer.innerHTML+=`<span>Longest Single Run: ${maxDistance} km</span>`;
    filtered.forEach(r=>{
        const runHour = new Date(r.date+'T00:00:00').getHours();
        if(runHour < 10) badgesContainer.innerHTML += '<span>Morning Runner</span>';
    });

    // Leaderboard - aggregate by name, no duplicates
    const leaderboardTotals = {};
    activities.forEach(r=>{
        if(!leaderboardTotals[r.name]){
            leaderboardTotals[r.name] = {distance:0, points:0};
        }
        leaderboardTotals[r.name].distance += r.distance;
        leaderboardTotals[r.name].points += Math.floor(r.distance / 5);
    });
    const leaderboardArr = Object.entries(leaderboardTotals)
        .sort((a,b)=>b[1].distance - a[1].distance)
        .slice(0,5);
    leaderboardBody.innerHTML='';
    leaderboardArr.forEach(([name, data])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${data.distance.toFixed(2)}</td><td>${data.points}</td>`;
        leaderboardBody.appendChild(tr);
    });
}

filterSelect.addEventListener('change', fetchActivities);
fetchActivities();
</script>
</body>
</html>
