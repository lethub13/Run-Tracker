<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Run Tracker</title>
<style>
  :root { --bg:#f5f5f5; --card:#fff; --text:#111; --muted:#666; --brand:#0b67ff; --brand-d:#0852c7; }
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); margin: 20px; }
  h1 { text-align: center; margin-bottom: 16px; }
  .wrap { max-width: 900px; margin: 0 auto; display: grid; gap: 20px; }
  .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,.12); padding: 16px; }
  form label { display: grid; grid-template-columns: 160px 1fr; align-items: center; gap: 8px; margin: 10px 0; }
  input, select, button { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; }
  button { background: var(--brand); color: #fff; border: 1px solid transparent; cursor: pointer; }
  button:hover { background: var(--brand-d); }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .btn-secondary { background:#eee; color:#111; border-color:#ddd; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row>* { flex:1 1 220px; }
  .table-wrap { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border:1px solid #ddd; padding:8px; text-align:center; }
  th { background:#eee; }
  .muted { color:var(--muted); }
  .toast { position:fixed; right:16px; bottom:16px; background:#222; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; transform:translateY(8px); transition:.25s; }
  .toast.show { opacity:1; transform:translateY(0); }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal-backdrop.show { display:flex; }
  .modal { background:#fff; width:min(520px,92vw); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:16px; }
  .picker-grid { display:grid; grid-template-columns:auto 1fr auto 1fr auto 1fr; gap:8px; align-items:center; }
  .picker-grid select { font-size:18px; padding:8px 10px; height:44px; }
  .colon { font-size:20px; font-weight:700; }
  .display-chip { display:inline-flex; align-items:center; gap:8px; border:1px solid #ddd; border-radius:6px; padding:8px 10px; background:#fafafa; }
  .display-chip code { font-weight:700; }
  .hide { display:none; }
</style>
</head>
<body>
<h1>Run Tracker</h1>

<div class="wrap">
  <div class="card">
    <form id="runForm">
      <div class="row">
        <label>Date: <input type="date" id="date" required /></label>
        <label>Name: <input type="text" id="name" placeholder="Your name" required /></label>
      </div>
      <div class="row">
        <label>Distance (km): <input type="number" id="distance" step="0.01" min="0.01" placeholder="e.g. 5" required /></label>
        <label>Time (duration):
          <span class="display-chip">
            <code id="timeDisplay">--:--:--</code>
            <button id="openTimePicker" type="button" class="btn-secondary">Pick Time</button>
          </span>
          <input type="hidden" id="time" value="" />
        </label>
      </div>
      <div class="row"><button id="submitBtn" type="submit" disabled>Add Run</button><span id="status" class="muted"></span></div>
    </form>
  </div>

  <div class="card">
    <div class="row">
      <label for="filterSelect">Filter by Name:
        <select id="filterSelect"><option value="">-- All Names --</option></select>
      </label>
      <button id="refreshBtn" type="button" style="max-width:160px">Refresh</button>
    </div>
  </div>

  <div class="card">
    <h2>Past Activities</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Date</th><th>Name</th><th>Distance (km)</th><th>Time</th><th>Pace (min/km)</th></tr></thead>
        <tbody id="activitiesTable"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Leaderboard</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Name</th><th>Total Distance (km)</th><th>Total Time</th><th>Badge</th></tr></thead>
        <tbody id="leaderboardTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Time picker -->
<div id="timeModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Select Duration</h3>
    <div class="picker-grid">
      <label class="hide" id="labelH">H <select id="tpHours" aria-label="Hours"></select></label>
      <div class="colon hide" id="colonH">:</div>
      <label>M <select id="tpMinutes" aria-label="Minutes"></select></label>
      <div class="colon">:</div>
      <label>S <select id="tpSeconds" aria-label="Seconds"></select></label>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:12px;gap:10px">
      <div><input type="checkbox" id="enableHours" /> <label for="enableHours">Add hours</label></div>
      <div><button type="button" id="tpCancel" class="btn-secondary">Cancel</button> <button type="button" id="tpSet">Set</button></div>
    </div>
  </div>
</div>

<script>
const scriptUrl = "/api/proxy";

/* DOM */
const runForm = document.getElementById("runForm");
const activitiesTable = document.getElementById("activitiesTable");
const leaderboardTable = document.getElementById("leaderboardTable");
const filterSelect = document.getElementById("filterSelect");
const refreshBtn = document.getElementById("refreshBtn");
const statusEl = document.getElementById("status");
const submitBtn = document.getElementById("submitBtn");
const toastEl = document.getElementById("toast");

/* time widgets */
const timeHidden = document.getElementById("time");
const timeDisplay = document.getElementById("timeDisplay");
const timeModal = document.getElementById("timeModal");
const openTimePicker = document.getElementById("openTimePicker");
const tpHours = document.getElementById("tpHours");
const tpMinutes = document.getElementById("tpMinutes");
const tpSeconds = document.getElementById("tpSeconds");
const tpSet = document.getElementById("tpSet");
const tpCancel = document.getElementById("tpCancel");
const enableHours = document.getElementById("enableHours");
const labelH = document.getElementById("labelH");
const colonH = document.getElementById("colonH");

/* utils */
function toast(m){ toastEl.textContent=m; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"),2000); }
const pad2=n=>String(n).padStart(2,"0");
function normalizeTimeStr(t){
  if(!t) return "";
  const s=String(t).trim();
  if (s.includes("T")) return s.split("T")[1].slice(0,8);
  if (/^\d{1,2}:[0-5]\d$/.test(s)) return `00:${s}`;
  if (/^\d{1,2}:[0-5]\d:[0-5]\d$/.test(s)) { const [h,m,ss]=s.split(":"); return `${pad2(h)}:${m}:${ss}`; }
  return s;
}
function timeToSeconds(t){ const s=normalizeTimeStr(t); if(!s) return 0; const [h,m,ss]=s.split(":").map(Number); if([h,m,ss].some(isNaN)) return 0; return h*3600+m*60+ss; }
function secondsToHMS(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=Math.floor(sec%60); return [h,m,s].map(pad2).join(":"); }
function calcPace(km,t){ const s=timeToSeconds(t); if(!km||s<=0) return "-"; const spk=s/km; const m=Math.floor(spk/60), ss=Math.round(spk%60); return `${m}:${pad2(ss)}`; }
function getBadge(km){ if (km>=42.2) return "ðŸ… Marathon"; if (km>=21.1) return "ðŸ¥ˆ Half"; if (km>=10) return "ðŸ¥‰ 10K"; return ""; }
function formatDate(d){ return d && d.includes("T") ? d.split("T")[0] : (d||""); }

/* picker */
function buildTimeOptions(){ tpHours.innerHTML=""; tpMinutes.innerHTML=""; tpSeconds.innerHTML="";
  for(let h=0;h<=23;h++){ const o=document.createElement("option"); o.value=pad2(h); o.textContent=pad2(h); tpHours.appendChild(o); }
  for(let m=0;m<=59;m++){ const o1=document.createElement("option"); o1.value=pad2(m); o1.textContent=pad2(m); tpMinutes.appendChild(o1); const o2=document.createElement("option"); o2.value=pad2(m); o2.textContent=pad2(m); tpSeconds.appendChild(o2); }
}
function setHoursUI(on){ [labelH,colonH].forEach(el=>el.classList.toggle("hide",!on)); if(!on) tpHours.value="00"; }
function openPicker(){ const base=timeHidden.value||"00:00:00"; const [h,m,s]=normalizeTimeStr(base).split(":"); tpHours.value=h; tpMinutes.value=m; tpSeconds.value=s; timeModal.classList.add("show"); timeModal.setAttribute("aria-hidden","false"); }
function closePicker(){ timeModal.classList.remove("show"); timeModal.setAttribute("aria-hidden","true"); }
openTimePicker.addEventListener("click", openPicker);
tpCancel.addEventListener("click", closePicker);
timeModal.addEventListener("click", e=>{ if(e.target===timeModal) closePicker(); });
tpSet.addEventListener("click", ()=>{ const hours=enableHours.checked?tpHours.value:"00"; const val=`${hours}:${tpMinutes.value}:${tpSeconds.value}`; timeHidden.value=val; timeDisplay.textContent=val; submitBtn.disabled=false; closePicker(); });
enableHours.addEventListener("change", ()=> setHoursUI(enableHours.checked));
buildTimeOptions(); setHoursUI(false);

/* data fetch */
async function fetchActivities(){
  statusEl.textContent="Loadingâ€¦";
  try{
    const res = await fetch(scriptUrl,{ cache:"no-store" });
    const items = await res.json();

    const prev = filterSelect.value;
    filterSelect.innerHTML = '<option value="">-- All Names --</option>';
    [...new Set(items.map(x=>x.name).filter(Boolean))].sort().forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; if(n===prev) o.selected=true; filterSelect.appendChild(o); });
    const f = filterSelect.value.trim().toLowerCase();
    const rows = f ? items.filter(r => (r.name||"").toLowerCase()===f) : items;

    activitiesTable.innerHTML="";
    if(!rows.length){ activitiesTable.innerHTML="<tr><td colspan='5' class='muted'>No runs yet</td></tr>"; }
    else rows.forEach(r=>{
      const dist = parseFloat(String(r.distance).replace(',','.'))||0;
      const time = normalizeTimeStr(r.time||"");
      const pace = r.pace || calcPace(dist,time);
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${formatDate(r.date)}</td><td>${r.name||""}</td><td>${dist?dist.toFixed(2):""}</td><td>${time}</td><td>${pace}</td>`;
      activitiesTable.appendChild(tr);
    });

    const agg={};
    items.forEach(r=>{ const n=r.name||""; const d=parseFloat(String(r.distance).replace(',','.'))||0; const s=timeToSeconds(r.time); if(!agg[n]) agg[n]={dist:0,secs:0}; agg[n].dist+=d; agg[n].secs+=s; });
    const sorted = Object.entries(agg).filter(([n])=>n).sort((a,b)=>b[1].dist-a[1].dist);
    leaderboardTable.innerHTML = sorted.length ? "" : "<tr><td colspan='4' class='muted'>No runners yet</td></tr>";
    sorted.forEach(([n,v])=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${n}</td><td>${v.dist.toFixed(2)}</td><td>${secondsToHMS(v.secs)}</td><td>${getBadge(v.dist)}</td>`; leaderboardTable.appendChild(tr); });

  }catch(e){ console.error(e); toast("Failed to load"); }
  finally{ statusEl.textContent=""; }
}

/* submit */
runForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const t = normalizeTimeStr(timeHidden.value);
  if(!t){ toast("Pick a time"); return; }

  const payload = {
    date: document.getElementById("date").value,
    name: document.getElementById("name").value.trim(),
    distance: document.getElementById("distance").value,
    time: t,
    hoursEnabled: enableHours.checked === true
  };

  try{
    const resp = await fetch(scriptUrl,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload), cache:"no-store" });
    const json = await resp.json().catch(()=>({}));
    if(!resp.ok || json.ok===false){ console.error("Save error:",json); toast("Could not save"); return; }

    runForm.reset(); timeHidden.value=""; timeDisplay.textContent="--:--:--"; submitBtn.disabled=true; setHoursUI(false);
    toast("Run added"); await fetchActivities();
  }catch(err){ console.error(err); toast("Network error"); }
});

filterSelect.addEventListener("change", fetchActivities);
refreshBtn.addEventListener("click", fetchActivities);
fetchActivities();
</script>
</body>
</html>

