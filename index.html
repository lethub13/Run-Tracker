<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Run Tracker</title>
<style>
  :root { --bg:#f5f5f5; --card:#fff; --text:#111; --muted:#666; --brand:#0b67ff; --brand-d:#0852c7; }
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); margin: 20px; }
  h1 { text-align: center; margin-bottom: 16px; }
  .wrap { max-width: 980px; margin: 0 auto; display: grid; gap: 20px; }
  .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,.12); padding: 16px; }
  form label { display: grid; grid-template-columns: 160px 1fr; align-items: center; gap: 8px; margin: 10px 0; }
  input, select, button { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; }
  button { background: var(--brand); color: #fff; border: 1px solid transparent; cursor: pointer; }
  button:hover { background: var(--brand-d); }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .btn-secondary { background:#eee; color:#111; border-color:#ddd; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row>* { flex:1 1 220px; }
  .table-wrap { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border:1px solid #ddd; padding:8px; text-align:center; vertical-align: middle; }
  th { background:#eee; }
  .muted { color:var(--muted); }
  .toast { position:fixed; right:16px; bottom:16px; background:#222; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; transform:translateY(8px); transition:.25s; z-index:1000; }
  .toast.show { opacity:1; transform:translateY(0); }

  /* Time picker modal */
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:900; }
  .modal-backdrop.show { display:flex; }
  .modal { background:#fff; width:min(520px,92vw); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:16px; }
  .picker-grid { display:grid; grid-template-columns:auto 1fr auto 1fr auto 1fr; gap:8px; align-items:center; }
  .picker-grid select { font-size:18px; padding:8px 10px; height:44px; }
  .colon { font-size:20px; font-weight:700; }
  .display-chip { display:inline-flex; align-items:center; gap:8px; border:1px solid #ddd; border-radius:6px; padding:8px 10px; background:#fafafa; }
  .display-chip code { font-weight:700; }
  .hide { display:none; }

  /* Badge & PB chips */
  .badges { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
  .badge  { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #e5e5e5; border-radius:999px; background:#fafafa; font-size:12px; white-space:nowrap; }
  .badge i { font-style: normal; }
  .pbs { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
  .pb-chip { display:inline-flex; gap:6px; padding:4px 8px; border:1px solid #e5e5e5; border-radius:999px; background:#eef7ff; font-size:12px; white-space:nowrap; }

  /* Collapsible sections */
  details.card { padding: 0; }
  details.card > .content { padding: 0 16px 16px 16px; }
  .summary-row {
    list-style: none; display: flex; align-items: center; justify-content: space-between;
    gap: 12px; padding: 14px 16px; cursor: pointer; font-weight: 700; border-bottom: 1px solid #eee; user-select: none;
  }
  .summary-row .right { display:flex; align-items:center; gap:8px; }
  .chev { transition: transform .2s ease; }
  details[open] .chev { transform: rotate(0deg); }
  details:not([open]) .chev { transform: rotate(-90deg); }
  .count { font-weight: 400; color: var(--muted); margin-left: 6px; }

  /* Tiny controls row */
  .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

  /* Avatars */
  .name-cell { display:flex; align-items:center; gap:8px; }
  .avatar {
    width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center;
    font-size:12px; font-weight:700; color:#fff; flex:0 0 28px;
  }

  /* Fireworks canvas */
  #confettiCanvas { position: fixed; inset: 0; pointer-events: none; z-index: 1100; }
  /* Invite modal tweaks */
  .qr-wrap { display:flex; flex-direction:column; align-items:center; gap:10px; }
  .qr-wrap img { width:220px; height:220px; }
  .qr-link { font-size:12px; color:var(--muted); word-break:break-all; text-align:center; }
</style>
</head>
<body>
<canvas id="confettiCanvas"></canvas>
<h1>Run Tracker</h1>

<div class="wrap">
  <!-- Add Run -->
  <div class="card">
    <form id="runForm">
      <div class="row">
        <label>Date: <input type="date" id="date" required /></label>
        <label>Name: <input type="text" id="name" placeholder="Your name" required /></label>
      </div>
      <div class="row">
        <label>Distance (km): <input type="number" id="distance" step="0.01" min="0.01" placeholder="e.g. 5" required /></label>
        <label>Time (duration):
          <span class="display-chip">
            <code id="timeDisplay">--:--:--</code>
            <button id="openTimePicker" type="button" class="btn-secondary">Pick Time</button>
          </span>
          <input type="hidden" id="time" value="" />
        </label>
      </div>
      <div class="row">
        <button id="submitBtn" type="submit" disabled>Add Run</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </div>

  <!-- Filters + global controls -->
  <div class="card">
    <div class="row">
      <label for="filterSelect">Filter by Name:
        <select id="filterSelect"><option value="">-- All Names --</option></select>
      </label>
      <div class="controls" style="flex:1; justify-content:flex-end;">
        <button id="inviteBtn" type="button" class="btn-secondary">Invite</button>
        <button id="exportCsvBtn" type="button" class="btn-secondary">Export CSV</button>
        <button id="expandAllBtn" type="button" class="btn-secondary">Expand all</button>
        <button id="collapseAllBtn" type="button" class="btn-secondary">Collapse all</button>
        <button id="refreshBtn" type="button" class="btn-secondary">Refresh</button>
      </div>
    </div>
  </div>

  <!-- Past Activities (collapsible) -->
  <details id="secActivities" class="card" open>
    <summary class="summary-row">
      <span>Past Activities <span id="activitiesCount" class="count"></span></span>
      <span class="right"><span id="activitiesTotal" class="muted"></span><span class="chev" aria-hidden="true">▾</span></span>
    </summary>
    <div class="content">
      <div class="table-wrap">
        <table aria-live="polite">
          <thead><tr><th>Date</th><th>Name</th><th>Distance (km)</th><th>Time</th><th>Pace (min/km)</th></tr></thead>
          <tbody id="activitiesTable"></tbody>
        </table>
      </div>
    </div>
  </details>

  <!-- Leaderboard (collapsible) -->
  <details id="secLeaderboard" class="card" open>
    <summary class="summary-row">
      <span>Leaderboard <span id="leaderboardCount" class="count"></span></span>
      <span class="right"><span class="chev" aria-hidden="true">▾</span></span>
    </summary>
    <div class="content">
      <div class="table-wrap">
        <table aria-live="polite">
          <thead>
            <tr>
              <th>Name</th>
              <th>Total Distance (km)</th>
              <th>Total Time</th>
              <th>Badges</th>
              <th>PBs</th>
            </tr>
          </thead>
          <tbody id="leaderboardTable"></tbody>
        </table>
      </div>
    </div>
  </details>

  <!-- Support -->
  <div class="card" style="text-align:center">
    <h3>Support this App</h3>
    <form action="https://www.paypal.com/donate" method="post" target="_top">
      <input type="hidden" name="hosted_button_id" value="WYBRQ9EGCMK4Y" />
      <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="Donate with PayPal button" style="max-width:100%;height:auto;" />
    </form>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Time picker modal -->
<div id="timeModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Select Duration</h3>
    <div class="picker-grid">
      <label class="hide" id="labelH">H
        <select id="tpHours" aria-label="Hours"></select>
      </label>
      <div class="colon hide" id="colonH">:</div>
      <label>M
        <select id="tpMinutes" aria-label="Minutes"></select>
      </label>
      <div class="colon">:</div>
      <label>S
        <select id="tpSeconds" aria-label="Seconds"></select>
      </label>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:12px;gap:10px">
      <div><input type="checkbox" id="enableHours" /> <label for="enableHours">Add hours</label></div>
      <div><button type="button" id="tpCancel" class="btn-secondary">Cancel</button> <button type="button" id="tpSet">Set</button></div>
    </div>
  </div>
</div>

<!-- Invite modal -->
<div id="inviteModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Invite people</h3>
    <div class="qr-wrap">
      <img id="qrImg" alt="Invite QR" />
      <div class="qr-link" id="inviteLink"></div>
      <div style="display:flex; gap:8px;">
        <button id="copyInviteBtn" class="btn-secondary" type="button">Copy link</button>
        <button id="closeInviteBtn" class="btn-secondary" type="button">Close</button>
      </div>
      <small class="muted">QR includes current name filter if set.</small>
    </div>
  </div>
</div>

<script>
/* ===== Config (Vercel) ===== */
const scriptUrl = "/api/proxy";

/* ===== DOM ===== */
const runForm = document.getElementById("runForm");
const activitiesTable = document.getElementById("activitiesTable");
const leaderboardTable = document.getElementById("leaderboardTable");
const filterSelect = document.getElementById("filterSelect");
const statusEl = document.getElementById("status");
const refreshBtn = document.getElementById("refreshBtn");
const exportCsvBtn = document.getElementById("exportCsvBtn");
const expandAllBtn = document.getElementById("expandAllBtn");
const collapseAllBtn = document.getElementById("collapseAllBtn");
const inviteBtn = document.getElementById("inviteBtn");
const toastEl = document.getElementById("toast");
const submitBtn = document.getElementById("submitBtn");
const activitiesCountEl = document.getElementById("activitiesCount");
const activitiesTotalEl = document.getElementById("activitiesTotal");
const leaderboardCountEl = document.getElementById("leaderboardCount");
const secActivities = document.getElementById("secActivities");
const secLeaderboard = document.getElementById("secLeaderboard");

/* Time widgets */
const timeHidden = document.getElementById("time");
const timeDisplay = document.getElementById("timeDisplay");
const openTimePicker = document.getElementById("openTimePicker");
const timeModal = document.getElementById("timeModal");
const tpHours = document.getElementById("tpHours");
const tpMinutes = document.getElementById("tpMinutes");
const tpSeconds = document.getElementById("tpSeconds");
const tpSet = document.getElementById("tpSet");
const tpCancel = document.getElementById("tpCancel");
const enableHours = document.getElementById("enableHours");
const labelH = document.getElementById("labelH");
const colonH = document.getElementById("colonH");

/* Invite modal DOM */
const inviteModal = document.getElementById("inviteModal");
const qrImg = document.getElementById("qrImg");
const inviteLinkEl = document.getElementById("inviteLink");
const copyInviteBtn = document.getElementById("copyInviteBtn");
const closeInviteBtn = document.getElementById("closeInviteBtn");

/* ===== Utils ===== */
function toast(m){ toastEl.textContent=m; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"),2000); }
const pad2 = n => String(n).padStart(2,"0");
function normalizeTimeStr(t){
  if(!t) return "";
  const s=String(t).trim();
  if (s.includes("T")) return s.split("T")[1].slice(0,8);
  if (/^\d{1,2}:[0-5]\d$/.test(s)) return `00:${s}`;
  if (/^\d{1,2}:[0-5]\d:[0-5]\d$/.test(s)) { const [h,m,ss]=s.split(":"); return `${pad2(h)}:${m}:${ss}`; }
  return s;
}
function timeToSeconds(t){
  const s = normalizeTimeStr(t); if(!s) return 0;
  const [h,m,ss] = s.split(":").map(Number);
  if ([h,m,ss].some(Number.isNaN)) return 0;
  return h*3600 + m*60 + ss;
}
function secondsToHMS(sec){
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=Math.floor(sec%60);
  return [h,m,s].map(pad2).join(":");
}
function calcPace(distanceKm, timeStr){
  const secs = timeToSeconds(timeStr);
  if (!distanceKm || distanceKm <= 0 || secs <= 0) return "-";
  const pace = secs / distanceKm;
  const m = Math.floor(pace/60);
  const s = Math.round(pace % 60);
  return `${m}:${pad2(s)}`;
}
function formatDate(dateStr){ return dateStr && dateStr.includes("T") ? dateStr.split("T")[0] : (dateStr||""); }

/* ==== Badge logic: ALL earned badges (progress sash) ==== */
function getBadges(km) {
  const badges = [];
  if (km >= 5)    badges.push("🏁 5K");
  if (km >= 10)   badges.push("🥉 10K");
  if (km >= 21.1) badges.push("🥈 Half");
  if (km >= 42.2) badges.push("🎖️ Marathon");
  if (km >= 50)  badges.push("🏅 50 km");
  if (km >= 100) badges.push("🥇 100 km");
  if (km >= 150) badges.push("🏆 150 km");
  if (km >= 200) badges.push("🚀 200 km");
  if (km >= 250) badges.push("🗻 250 km");
  if (km >= 300) badges.push("👑 300+ km");
  return badges;
}

/* ===== PB specs (with tolerance) ===== */
const PB_SPECS = [
  { label: "5K",   target: 5.0,   tol: 0.25 },
  { label: "10K",  target: 10.0,  tol: 0.25 },
  { label: "Half", target: 21.1,  tol: 0.25 },
  { label: "Marathon", target: 42.2, tol: 0.25 }
];
function computePBsForRunner(runs){
  const pbs = [];
  PB_SPECS.forEach(spec=>{
    const candidates = runs.filter(r => Math.abs(r.distance - spec.target) <= spec.tol && r.secs > 0);
    if (candidates.length){
      const best = candidates.reduce((a,b)=> a.secs <= b.secs ? a : b);
      pbs.push({ label: spec.label, time: secondsToHMS(best.secs), date: best.date, distance: best.distance.toFixed(2), secs: best.secs });
    }
  });
  return pbs;
}

/* ===== Avatars ===== */
const PALETTE = [
  "#E57373","#F06292","#BA68C8","#9575CD","#7986CB","#64B5F6","#4FC3F7","#4DD0E1",
  "#4DB6AC","#81C784","#AED581","#DCE775","#FFF176","#FFD54F","#FFB74D","#A1887F",
  "#90A4AE"
];
function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
function colorForName(name){ if(!name) return "#888"; return PALETTE[hashCode(name)%PALETTE.length]; }
function initials(name){
  const parts=String(name||"").trim().split(/\s+/).filter(Boolean);
  if (!parts.length) return "?";
  if (parts.length===1) return parts[0].slice(0,2).toUpperCase();
  return (parts[0][0]+parts[1][0]).toUpperCase();
}
function avatarHTML(name){ const bg=colorForName(name), text=initials(name); return `<span class="avatar" style="background:${bg}">${text}</span>`; }

/* ===== Time Picker ===== */
function buildTimeOptions(){
  tpHours.innerHTML = ""; tpMinutes.innerHTML = ""; tpSeconds.innerHTML = "";
  for (let h=0; h<=23; h++){ const o=document.createElement("option"); o.value=pad2(h); o.textContent=pad2(h); tpHours.appendChild(o); }
  for (let m=0; m<=59; m++){
    const o1=document.createElement("option"); o1.value=pad2(m); o1.textContent=pad2(m); tpMinutes.appendChild(o1);
    const o2=document.createElement("option"); o2.value=pad2(m); o2.textContent=pad2(m); tpSeconds.appendChild(o2);
  }
}
function setHoursUI(on){ [labelH,colonH].forEach(el=>el.classList.toggle("hide",!on)); if(!on) tpHours.value="00"; }
function openPicker(){
  const base=timeHidden.value||"00:00:00";
  const [h,m,s]=normalizeTimeStr(base).split(":");
  tpHours.value=h; tpMinutes.value=m; tpSeconds.value=s;
  timeModal.classList.add("show"); timeModal.setAttribute("aria-hidden","false");
}
function closePicker(){ timeModal.classList.remove("show"); timeModal.setAttribute("aria-hidden","true"); }
openTimePicker.addEventListener("click", openPicker);
tpCancel.addEventListener("click", closePicker);
timeModal.addEventListener("click", e=>{ if (e.target===timeModal) closePicker(); });
tpSet.addEventListener("click", ()=>{
  const hours = enableHours.checked ? tpHours.value : "00";
  const val = `${hours}:${tpMinutes.value}:${tpSeconds.value}`;
  timeHidden.value = val;
  timeDisplay.textContent = val;
  submitBtn.disabled = false;
  closePicker();
});
enableHours.addEventListener("change", ()=> setHoursUI(enableHours.checked));
buildTimeOptions(); setHoursUI(false);

/* ===== State & data cache ===== */
let _allActivities = [];
let _filteredActivities = [];
let _perRunner = {};
let lastSubmittedName = null;     // set after POST to personalize fireworks

/* ===== Fireworks (confetti) ===== */
const confettiCanvas = document.getElementById("confettiCanvas");
const ctx = confettiCanvas.getContext("2d");
let confettiParticles = [];
function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
window.addEventListener("resize", resizeCanvas); resizeCanvas();
function spawnConfetti(n=180){
  const w=confettiCanvas.width, h=confettiCanvas.height;
  for(let i=0;i<n;i++){
    confettiParticles.push({
      x: Math.random()*w, y: -10, vx: (Math.random()-0.5)*3, vy: Math.random()*3+2,
      size: Math.random()*6+4, rot: Math.random()*360, vr: (Math.random()-0.5)*10,
      color: `hsl(${Math.floor(Math.random()*360)},90%,60%)`, life: 0
    });
  }
}
let confettiRAF=null;
function animateConfetti(){
  if (!confettiParticles.length) return;
  const w=confettiCanvas.width, h=confettiCanvas.height;
  ctx.clearRect(0,0,w,h);
  confettiParticles.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.rot+=p.vr; p.life+=1;
    ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
    ctx.fillStyle=p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
    ctx.restore();
  });
  confettiParticles = confettiParticles.filter(p=> p.y < h+20);
  confettiRAF = requestAnimationFrame(animateConfetti);
}
function triggerFireworks(msg){
  toast(msg || "Milestone!");
  spawnConfetti();
  if (!confettiRAF) animateConfetti();
  setTimeout(()=>{ confettiParticles=[]; if(confettiRAF){ cancelAnimationFrame(confettiRAF); confettiRAF=null; ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);} }, 2500);
}

/* ===== Milestone tracking in localStorage ===== */
function keyBadges(name){ return `rt.badges.${name}`; }
function keyPB(name){ return `rt.pb.${name}`; }

/* ===== Data Fetch + render ===== */
async function fetchActivities(){
  statusEl.textContent="Loading…";
  try{
    const res = await fetch(scriptUrl,{ cache: "no-store" });
    const activities = await res.json();

    activities.sort((a,b)=> new Date(b.date) - new Date(a.date));
    _allActivities = activities;

    // Build filter dropdown
    const prev = filterSelect.value;
    filterSelect.innerHTML = '<option value="">-- All Names --</option>';
    [...new Set(activities.map(r => r.name).filter(Boolean))].sort().forEach(name=>{
      const opt=document.createElement("option");
      opt.value=name; opt.textContent=name; if (name===prev) opt.selected=true; filterSelect.appendChild(opt);
    });

    const filter = filterSelect.value.trim().toLowerCase();
    const filtered = filter ? activities.filter(r => (r.name||"").toLowerCase()===filter) : activities;
    _filteredActivities = filtered;

    // Counts + totals
    activitiesCountEl.textContent = filtered.length ? `(${filtered.length})` : "";
    const totalKm = filtered.reduce((sum,r)=> sum + (parseFloat(String(r.distance).replace(",", "."))||0), 0);
    activitiesTotalEl.textContent = filtered.length ? `${totalKm.toFixed(2)} km` : "";

    // Activities table
    activitiesTable.innerHTML = "";
    if (!filtered.length){
      activitiesTable.innerHTML = "<tr><td colspan='5' class='muted'>No runs yet</td></tr>";
    } else {
      filtered.forEach(r=>{
        const date = formatDate(r.date);
        const name = r.name || "";
        const dist = parseFloat(String(r.distance).replace(",", ".")) || 0;
        const time = normalizeTimeStr(r.time || "");
        const pace = r.pace || calcPace(dist, time);
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${date}</td>
          <td><span class="name-cell">${avatarHTML(name)}<span>${name}</span></span></td>
          <td>${dist?dist.toFixed(2):""}</td>
          <td>${time||""}</td>
          <td>${pace}</td>`;
        activitiesTable.appendChild(tr);
      });
    }

    // Leaderboard aggregation + PBs
    const perRunner = {}; // name -> { dist, secs, runs:[] }
    activities.forEach(r=>{
      const name = r.name || "";
      const dist = parseFloat(String(r.distance).replace(",", ".")) || 0;
      const secs = timeToSeconds(r.time);
      if (!perRunner[name]) perRunner[name] = { dist:0, secs:0, runs:[] };
      perRunner[name].dist += dist;
      perRunner[name].secs += secs;
      perRunner[name].runs.push({ date: formatDate(r.date), distance: dist, time: normalizeTimeStr(r.time||""), secs });
    });
    _perRunner = perRunner;

    const sorted = Object.entries(perRunner).filter(([n])=>n).sort((a,b)=>b[1].dist-a[1].dist);
    leaderboardTable.innerHTML = "";
    leaderboardCountEl.textContent = sorted.length ? `(${sorted.length})` : "";

    if (!sorted.length){
      leaderboardTable.innerHTML = "<tr><td colspan='5' class='muted'>No runners yet</td></tr>";
    } else {
      sorted.forEach(([name, vals])=>{
        const badgesArr = getBadges(vals.dist);
        const badgesHtml = badgesArr.length
          ? `<div class="badges">${badgesArr.map(b => `<span class="badge"><i>${b.split(' ')[0]}</i><span>${b.replace(/^[^ ]+ /,'')}</span></span>`).join("")}</div>`
          : "";

        const pbs = computePBsForRunner(vals.runs);
        const pbsHtml = pbs.length
          ? `<div class="pbs">${pbs.map(pb => `<span class="pb-chip" title="${pb.label} on ${pb.date} (${pb.distance} km)">${pb.label} ${pb.time}</span>`).join("")}</div>`
          : "";

        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td><span class="name-cell">${avatarHTML(name)}<span>${name}</span></span></td>
          <td>${vals.dist.toFixed(2)}</td>
          <td>${secondsToHMS(vals.secs)}</td>
          <td>${badgesHtml}</td>
          <td>${pbsHtml}</td>
        `;
        leaderboardTable.appendChild(tr);
      });
    }

    // Fireworks: only check for the last person who submitted (if known)
    if (lastSubmittedName) checkMilestonesFor(lastSubmittedName);

  } catch(err){
    console.error(err);
    toast("Failed to load activities");
  } finally {
    statusEl.textContent="";
  }
}

/* ===== Milestone detection ===== */
function checkMilestonesFor(name){
  const data = _perRunner[name];
  if (!data) return;

  // New badges?
  const currentBadges = getBadges(data.dist);
  const stored = JSON.parse(localStorage.getItem(keyBadges(name) ) || "[]");
  const newlyEarned = currentBadges.filter(b => !stored.includes(b));
  if (newlyEarned.length){
    triggerFireworks(`${name} unlocked: ${newlyEarned.join(", ")}`);
    localStorage.setItem(keyBadges(name), JSON.stringify(currentBadges));
    return; // prefer one burst
  }

  // New PBs?
  const pbs = computePBsForRunner(data.runs);
  const storedPB = JSON.parse(localStorage.getItem(keyPB(name)) || "{}"); // {label: secs}
  let improved = [];
  pbs.forEach(pb=>{
    const prev = storedPB[pb.label];
    if (prev == null || pb.secs < prev - 0.5) improved.push(`${pb.label} ${pb.time}`);
    storedPB[pb.label] = pb.secs;
  });
  if (improved.length){
    triggerFireworks(`${name} new PB: ${improved[0]}`);
    localStorage.setItem(keyPB(name), JSON.stringify(storedPB));
  }
}

/* ===== Export CSV of current filtered rows ===== */
function exportFilteredToCSV(){
  const rows = _filteredActivities;
  if (!rows.length){ toast("Nothing to export"); return; }
  const header = ["Date","Name","Distance (km)","Time","Pace"];
  const lines = [header.join(",")];
  rows.forEach(r=>{
    const date = formatDate(r.date);
    const dist = parseFloat(String(r.distance).replace(",", ".")) || 0;
    const time = normalizeTimeStr(r.time || "");
    const pace = r.pace || calcPace(dist, time);
    const safe = [date, r.name||"", dist.toFixed(2), time, pace].map(v=>{
      const s=String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    });
    lines.push(safe.join(","));
  });
  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const name = filterSelect.value ? `runs_${filterSelect.value}.csv` : "runs_all.csv";
  a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ===== Invite modal / QR ===== */
function openInvite(){
  const base = window.location.origin + window.location.pathname;
  const nameFilter = filterSelect.value ? `?name=${encodeURIComponent(filterSelect.value)}` : "";
  const link = base + nameFilter;
  inviteLinkEl.textContent = link;
  const qrURL = "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(link);
  qrImg.src = qrURL;
  inviteModal.classList.add("show"); inviteModal.setAttribute("aria-hidden","false");
}
function closeInvite(){ inviteModal.classList.remove("show"); inviteModal.setAttribute("aria-hidden","true"); }
inviteBtn.addEventListener("click", openInvite);
closeInviteBtn.addEventListener("click", closeInvite);
inviteModal.addEventListener("click", e=>{ if(e.target===inviteModal) closeInvite(); });
copyInviteBtn.addEventListener("click", async ()=>{
  const text = inviteLinkEl.textContent;
  try{ await navigator.clipboard.writeText(text); toast("Invite link copied"); } catch{ toast("Copy failed"); }
});

/* ===== Submit Handler ===== */
runForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const t = normalizeTimeStr(timeHidden.value);
  if (!t){ toast("Pick a time"); return; }

  const name = document.getElementById("name").value.trim();
  const payload = {
    date: document.getElementById("date").value,
    name,
    distance: document.getElementById("distance").value,
    time: t,
    hoursEnabled: enableHours.checked === true
  };

  try{
    const resp = await fetch(scriptUrl,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
      cache: "no-store"
    });
    const json = await resp.json().catch(()=>({}));
    if (!resp.ok || json.ok === false){
      console.error("Save error:", json);
      toast("Could not save");
      return;
    }

    // remember who submitted; used to check fireworks after refresh
    lastSubmittedName = name;

    runForm.reset();
    timeHidden.value=""; timeDisplay.textContent="--:--:--"; submitBtn.disabled=true; setHoursUI(false);
    toast("Run added");
    await fetchActivities();
  } catch (err){
    console.error(err);
    toast("Network error while saving");
  }
});

/* ===== Persist open/closed states ===== */
(function persistOpenState(id, key){
  const det = document.getElementById(id);
  const saved = localStorage.getItem(key);
  if (saved !== null) det.open = saved === "1";
  det.addEventListener("toggle", () => {
    localStorage.setItem(key, det.open ? "1" : "0");
  });
})("secActivities","rt.activities.open");
(function(){
  const det = document.getElementById("secLeaderboard");
  const KEY = "rt.leaderboard.open";
  const saved = localStorage.getItem(KEY);
  if (saved !== null) det.open = saved === "1";
  det.addEventListener("toggle", () => {
    localStorage.setItem(KEY, det.open ? "1" : "0");
  });
})();

/* ===== Interactions ===== */
filterSelect.addEventListener("change", fetchActivities);
document.getElementById("refreshBtn").addEventListener("click", fetchActivities);
exportCsvBtn.addEventListener("click", exportFilteredToCSV);
expandAllBtn.addEventListener("click", ()=>{ secActivities.open = true; secLeaderboard.open = true; });
collapseAllBtn.addEventListener("click", ()=>{ secActivities.open = false; secLeaderboard.open = false; });

/* ===== Initial Load ===== */
fetchActivities();

/* ===== Time picker helpers (ensure after DOM used) ===== */
function setHoursUI(on){ [labelH,colonH].forEach(el=>el.classList.toggle("hide",!on)); if(!on) tpHours.value="00"; }
</script>
</body>
</html>
